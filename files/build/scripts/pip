#!/bin/bash
  
. /usr/local/share/buildinfo/config/buildinfo.config

[ -z "$PIP_COMPONENT" ] && PIP_COMPONENT=py2

ENABLE_VERSION_CONTROL=n
if [ "$PIP_COMPONENT" == "py2" ]; then
    [ "$ENABLE_VERSION_CONTROL_PY2" == "y" ] && ENABLE_VERSION_CONTROL=y
    PIP_COMMAND=/usr/local/bin/pip
    [ ! -f $PIP_COMMAND ] && PIP_COMMAND=/usr/bin/pip
else
    PIP_COMMAND=/usr/bin/pip3
    [ "$ENABLE_VERSION_CONTROL_PY3" == "y" ] && ENABLE_VERSION_CONTROL=y
fi

VERSION_FILE="$BUILDINFO_PATH/versions/versions-${PIP_COMPONENT}"
ENABLE_VERSION_CONTROL=$(check_version_control "$PIP_COMPONENT")


if [ "$ENABLE_VERSION_CONTROL" != "y" ]; then
    $PIP_COMMAND "$@"
    exit $?
fi

paras=("$@")
FOUND=false
INSTALL=false
VERSION_CONFIG_FILE="${VERSION_FILE}.config"
cp -f $VERSION_FILE $VERSION_CONFIG_FILE
for para in "${paras[@]}"
do
    ([ "$para" == "-c" ] || [ "$para" == "--constraint" ]) && FOUND=true
    [ "$para" == "install" ] && INSTALL=true
    if [[ "$para" == *.whl ]]; then
        package_name=$(echo $para | cut -d- -f1 | tr _ .)
        sed "/^${package_name}==/d" -i $VERSION_CONFIG_FILE
    fi
done

if [ "$FOUND" == "false" ] && [ "$INSTALL" == "true" ]; then
    paras+=("-c")
    paras+=("${VERSION_CONFIG_FILE}")
fi


if [ ! -x "$PIP_COMMAND" ] && [ " $1" == "freeze" ]; then
    exit 1
fi

$PIP_COMMAND ${paras[@]}
